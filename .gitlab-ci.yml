stages:
  - build
  - deploy


.kubectl:
  image:
    name: registry.git.rwth-aachen.de/zoomoid/docker-kubectl:1.18.4
    entrypoint: ['/docker-entrypoint.sh']
  before_script:
  - echo $kube_config | base64 -d > /root/runner
  - export KUBECONFIG="$KUBECONFIG:/root/runner"
  - kubectl config use-context runner@kubernetes
  tags:
  - kubernetes

.build-pre:
  only:
  - tags
  stage: build
  image: docker:latest
  before_script:
  - echo "$CI_JOB_TOKEN" | docker login registry.git.rwth-aachen.de --username gitlab-ci-token --password-stdin 
  tags:
  - kubernetes

build:api:
  extends: .build-pre
  script: 
    - cd api/
    - docker build -t $CI_REGISTRY_IMAGE/api:$CI_COMMIT_TAG .
    - docker push $CI_REGISTRY_IMAGE/api:$CI_COMMIT_TAG

build:client:
  extends: .build-pre
  script: 
    - cd client/
    - docker build -t $CI_REGISTRY_IMAGE/client:$CI_COMMIT_TAG .
    - docker push $CI_REGISTRY_IMAGE/client:$CI_COMMIT_TAG

build:watchdog:
  extends: .build-pre
  script: 
    - cd watchdog/
    - docker build -t $CI_REGISTRY_IMAGE/watchdog:$CI_COMMIT_TAG .
    - docker push $CI_REGISTRY_IMAGE/watchdog:$CI_COMMIT_TAG

deploy:
  only:
  - tags
  stage: deploy
  variables:
    CLIENT: "client"
    API: "api"
    WATCHDOG: "watchdog"
  extends: .kubectl
  script:
  - kubectl set image deployment/demo-$API $API=$CI_REGISTRY_IMAGE/api:$CI_COMMIT_TAG --record
  - kubectl set image deployment/demo-$CLIENT $CLIENT=$CI_REGISTRY_IMAGE/client:$CI_COMMIT_TAG --record
  - kubectl set image deployment/demo-$WATCHDOG $WATCHDOG=$CI_REGISTRY_IMAGE/watchdog:$CI_COMMIT_TAG --record
  