stages:
  - build
  - deploy

.kubectl:
  image:
    name: registry.git.rwth-aachen.de/zoomoid/docker-kubectl:latest
    entrypoint: ['/docker-entrypoint.sh']
  before_script:
    - echo $kube_config | base64 -d > /root/runner
    - export KUBECONFIG="$KUBECONFIG:/root/runner"
    - kubectl config use-context runner@kubernetes
  tags:
    - kubernetes

variables:
  DEPLOYMENT: 'demo-zoomoid-de'

build-staging:
  except:
    - master
  image: docker:latest
  stage: build
  script: 
    - echo "$CI_JOB_TOKEN" | docker login registry.git.rwth-aachen.de --username gitlab-ci-token --password-stdin 
    - docker build -t $CI_REGISTRY_IMAGE/nightly:$CI_COMMIT_SHORT_SHA .
    - docker push $CI_REGISTRY_IMAGE/nightly:$CI_COMMIT_SHORT_SHA
    - docker tag $CI_REGISTRY_IMAGE/nightly:$CI_COMMIT_SHORT_SHA $CI_REGISTRY_IMAGE/nightly:latest
    - docker push $CI_REGISTRY_IMAGE/nightly:latest
  tags: 
    - occloxium-docker

build-prod:
  image: docker:latest
  stage: build
  script: 
    - echo "$CI_JOB_TOKEN" | docker login registry.git.rwth-aachen.de --username gitlab-ci-token --password-stdin 
    - docker build -t $CI_REGISTRY_IMAGE/stable .
    - docker push $CI_REGISTRY_IMAGE/stable:latest
  tags: 
    - occloxium-docker

deploy-prod:
  only:
  - master
  stage: deploy
  extends: .kubectl
  script:
  - kubectl rollout restart deployment/$DEPLOYMENT
  